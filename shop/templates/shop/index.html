<!DOCTYPE html>
<html lang="ru">
<head>
    <meta name="viewport" content="width=device-width" />
    <title>MotoCREW.org/Главная</title>
    <link rel="stylesheet" type="text/css" href="../../../static/css/styles_index.css">
</head>

<body>

    <header>
        <a href="{% url 'index' %}">
            <img src="../../../static/img/home_logo.svg" alt="Логотип">
        </a>
    </header>

    <div class="content">
        <h3>Список товаров</h3>
        <table>
            <thead>
                <tr>
                    <th>Наименование</th>
                    <th>Тип</th>
                    <th>Цена</th>
                    <th>Действие</th>
                </tr>
            </thead>
            <tbody>
                {% for p in products %}
                    <tr id="product-{{ p.id }}">
                        <td>{{ p.name }}</td>
                        <td>{{ p.type }}</td>
                        <td>{{ p.price }}</td>
                        <td>
                            <a href="javascript:void(0);" class="buy-button" data-product-id="{{ p.id }}" onclick="addToCart(event, {{ p.price }})">
                                <i class="fa fa-shopping-cart"></i> В корзину
                            </a>
                            <div class="cart-controls" id="controls-{{ p.id }}" style="display:none;">
                                <input type="number" id="quantity-{{ p.id }}" value="1" min="1" class="quantity-input">
                                <button class="change-quantity" onclick="changeQuantity({{ p.id }}, 'increase')">+</button>
                                <button class="change-quantity" onclick="changeQuantity({{ p.id }}, 'decrease')">-</button>
                                <span class="total-price" id="total-price-{{ p.id }}">{{ p.price }}</span>
                                <button class="cancel-button" onclick="cancelAddition({{ p.id }})">Отменить</button>
                            </div>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="center-button">
            <a href="/purchase_form/" class="buy-button">
                <i class="fa fa-plus"></i> Перейти в корзину
            </a>
        </div>

    </div>

    <footer>
        <img src="../../../static/img/footer_without_back.png" alt="Футер">
    </footer>

    <script>
        // Функция для добавления товара в корзину
        function addToCart(event, price) {
            const button = event.target.closest('a');
            const productId = button.getAttribute('data-product-id');
            const controls = document.getElementById('controls-' + productId);
            const quantityInput = document.getElementById('quantity-' + productId);
            const totalPriceElement = document.getElementById('total-price-' + productId);

            // Показать элементы управления
            controls.style.display = 'inline-block';

            // Скрыть кнопку "В корзину"
            button.style.display = 'none';

            // Инициализация отображаемой цены
            totalPriceElement.innerText = price * parseInt(quantityInput.value);

            // Убедиться, что товар добавлен в корзину с начальным количеством 1
            localStorage.setItem('cart-' + productId, JSON.stringify({
                quantity: 1,
                price: price
            }));
        }

        // Функция для изменения количества товара
        function changeQuantity(productId, action) {
            const quantityInput = document.getElementById('quantity-' + productId);
            const totalPriceElement = document.getElementById('total-price-' + productId);
            let quantity = parseInt(quantityInput.value);
            const price = JSON.parse(localStorage.getItem('cart-' + productId)).price;

            if (action === 'increase') {
                quantity += 1;
            } else if (action === 'decrease' && quantity > 1) {
                quantity -= 1;
            }

            quantityInput.value = quantity;
            totalPriceElement.innerText = price * quantity;

            // Обновить в localStorage
            localStorage.setItem('cart-' + productId, JSON.stringify({
                quantity: quantity,
                price: price
            }));
        }

        // Функция для отмены добавления товара
        function cancelAddition(productId) {
            const controls = document.getElementById('controls-' + productId);
            const button = document.querySelector(`a[data-product-id='${productId}']`);

            // Скрыть элементы управления
            controls.style.display = 'none';

            // Показать кнопку "В корзину"
            button.style.display = 'inline-block';

            // Удалить товар из localStorage
            localStorage.removeItem('cart-' + productId);
        }
    </script>

</body>
</html>
